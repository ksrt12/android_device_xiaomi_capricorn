From ad30148af7744e75a9d2e3405e33a2bb7ec61bfe Mon Sep 17 00:00:00 2001
From: Harsh Shandilya <msfjarvis@gmail.com>
Date: Thu, 24 Aug 2017 13:34:12 +0000
Subject: [PATCH 2/2] DeviceInfoSettings: Bring back CAF/AOSP tags

Change-Id: I8d9a50abbd9158704c8d32edcb8de60172a21475
Signed-off-by: Simao Gomes Viana <xdevs23@outlook.com>
Signed-off-by: Harsh Shandilya <harsh@prjkt.io>
Signed-off-by: Kazakov Stepan <ksrt12group@gmail.com>
---
 res/values/havoc_strings.xml                  |  6 +-
 res/xml/my_device_info.xml                    |  8 +++
 .../RomTagsPreferenceController.java          | 68 +++++++++++++++++++
 .../aboutphone/MyDeviceInfoFragment.java      |  2 +
 4 files changed, 82 insertions(+), 2 deletions(-)
 create mode 100644 src/com/android/settings/deviceinfo/RomTagsPreferenceController.java

diff --git a/res/values/havoc_strings.xml b/res/values/havoc_strings.xml
index 4d97be82b9..8987b7c74a 100644
--- a/res/values/havoc_strings.xml
+++ b/res/values/havoc_strings.xml
@@ -425,6 +425,9 @@
     <string name="data_usage_app_restrict_wifi">Wi\u2011Fi data</string>
     <string name="data_usage_app_restrict_wifi_summary">Enable usage of Wi\u2011Fi data</string>
 
+    <!-- ROM tags information -->
+    <string name="rom_tags_title">Tags</string>
+
     <!-- Selinux -->
     <string name="selinux_status">SELinux status</string>
     <string name="selinux_status_disabled">Disabled</string>
@@ -453,8 +456,7 @@
     <string name="battery_status">Status</string>
     <string name="battery_voltage">Voltage</string>
     <string name="battery_health">Health</string>
-
     <string name="font_picker_title">Font Manager</string>
     <string name="disable_fonts_installed_title">Font picker is unavailable to avoid conflicts with Substratum. Uninstall it if you wish to use the font picker.</string>
     <string name="font_picker_progress">Applying new font\u2026</string>
-</resources>
\ No newline at end of file
+</resources>
diff --git a/res/xml/my_device_info.xml b/res/xml/my_device_info.xml
index 4e584371d3..aae0f88bdf 100644
--- a/res/xml/my_device_info.xml
+++ b/res/xml/my_device_info.xml
@@ -150,6 +150,14 @@
         android:summary="@string/summary_placeholder"
         settings:allowDividerAbove="true"/>
 
+    <!-- ROM tags information -->
+    <Preference
+        android:key="romtags"
+        android:order="98"
+        android:title="@string/rom_tags_title"
+        android:summary="@string/summary_placeholder"
+        android:selectable="false"/>
+
     <!-- SELinux status information -->
     <Preference
         android:key="selinux_status"
diff --git a/src/com/android/settings/deviceinfo/RomTagsPreferenceController.java b/src/com/android/settings/deviceinfo/RomTagsPreferenceController.java
new file mode 100644
index 0000000000..d2adeafacf
--- /dev/null
+++ b/src/com/android/settings/deviceinfo/RomTagsPreferenceController.java
@@ -0,0 +1,68 @@
+/*
+ * Copyright (C) 2017 The halogenOS Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package com.android.settings.deviceinfo;
+
+import android.content.Context;
+import android.os.SystemProperties;
+import android.support.v7.preference.Preference;
+import android.support.v7.preference.PreferenceScreen;
+import android.text.TextUtils;
+
+import com.android.settings.R;
+import com.android.settings.core.PreferenceControllerMixin;
+import com.android.settingslib.core.AbstractPreferenceController;
+
+public class RomTagsPreferenceController extends AbstractPreferenceController implements
+      PreferenceControllerMixin {
+
+    private static final String PROPERTY_MOD_REVISIONS = "ro.mod.romtags";
+    private static final String KEY_MOD_REVISIONS = "romtags";
+
+    public RomTagsPreferenceController(Context context) {
+        super(context);
+    }
+
+    @Override
+    public boolean isAvailable() {
+        return !TextUtils.isEmpty(SystemProperties.get(PROPERTY_MOD_REVISIONS));
+    }
+
+    @Override
+    public String getPreferenceKey() {
+        return KEY_MOD_REVISIONS;
+    }
+
+    @Override
+    public void displayPreference(PreferenceScreen screen) {
+        super.displayPreference(screen);
+        final Preference pref = screen.findPreference(KEY_MOD_REVISIONS);
+        if (pref == null) return;
+        String romtagsString = SystemProperties.get(PROPERTY_MOD_REVISIONS);
+        String cafRevision = "";
+        String droidRevision = "";
+        StringBuilder valueSummary = new StringBuilder();
+        if (romtagsString.contains("droid")) {
+            droidRevision = romtagsString.split(",")[0].split("=")[1];
+        }
+        if (romtagsString.contains("caf")) {
+            cafRevision = romtagsString.split(",")[1].split("=")[1];
+        }
+        valueSummary.append(TextUtils.isEmpty(droidRevision) ? "" : "AOSP: " + droidRevision + "\n");
+        valueSummary.append(TextUtils.isEmpty(cafRevision) ? "" : "CAF: " + cafRevision);
+        pref.setSummary(valueSummary.toString());
+    }
+}
+
diff --git a/src/com/android/settings/deviceinfo/aboutphone/MyDeviceInfoFragment.java b/src/com/android/settings/deviceinfo/aboutphone/MyDeviceInfoFragment.java
index 13169f919b..40a7efa467 100644
--- a/src/com/android/settings/deviceinfo/aboutphone/MyDeviceInfoFragment.java
+++ b/src/com/android/settings/deviceinfo/aboutphone/MyDeviceInfoFragment.java
@@ -46,6 +46,7 @@ import com.android.settings.deviceinfo.ManualPreferenceController;
 import com.android.settings.deviceinfo.PhoneNumberPreferenceController;
 import com.android.settings.deviceinfo.RegulatoryInfoPreferenceController;
 import com.android.settings.deviceinfo.SafetyInfoPreferenceController;
+import com.android.settings.deviceinfo.RomTagsPreferenceController;
 import com.android.settings.deviceinfo.SELinuxStatusPreferenceController;
 import com.android.settings.deviceinfo.WifiMacAddressPreferenceController;
 import com.android.settings.deviceinfo.firmwareversion.FirmwareVersionPreferenceController;
@@ -128,6 +129,7 @@ public class MyDeviceInfoFragment extends DashboardFragment
         controllers.add(new ManualPreferenceController(context));
         controllers.add(new FeedbackPreferenceController(fragment, context));
         controllers.add(new FccEquipmentIdPreferenceController(context));
+        controllers.add(new RomTagsPreferenceController(context));
         controllers.add(new SELinuxStatusPreferenceController(context));
         controllers.add(
                 new BuildNumberPreferenceController(context, activity, fragment, lifecycle));
-- 
2.19.1

