From e26a67abaf6883d02c2bf003a6abaf168cb3a615 Mon Sep 17 00:00:00 2001
From: Kazakov Stepan <ksrt12group@gmail.com>
Date: Mon, 3 Dec 2018 00:06:42 +0300
Subject: [PATCH 5/5] base: allow home button to wake device [1/2]

Signed-off-by: Kazakov Stepan <ksrt12group@gmail.com>
---
 core/java/android/provider/Settings.java      |  6 ++++
 core/java/android/view/KeyEvent.java          |  1 +
 .../server/policy/PhoneWindowManager.java     | 29 ++++++++++++++-----
 3 files changed, 29 insertions(+), 7 deletions(-)

diff --git a/core/java/android/provider/Settings.java b/core/java/android/provider/Settings.java
index fa7592375f0..edd5e79fe9b 100644
--- a/core/java/android/provider/Settings.java
+++ b/core/java/android/provider/Settings.java
@@ -5730,6 +5730,12 @@ public final class Settings {
         public static final String TOAST_ICON = "toast_icon";
 
         /**
+         * Whether to wake the screen with the home key, the value is boolean.
+         * @hide
+         */
+        public static final String HOME_WAKE_SCREEN = "home_wake_screen";
+
+         /**
          * Enable or disable wifi data activity indicators
          * @hide
          */
diff --git a/core/java/android/view/KeyEvent.java b/core/java/android/view/KeyEvent.java
index a59740563ce..4a58e63602c 100644
--- a/core/java/android/view/KeyEvent.java
+++ b/core/java/android/view/KeyEvent.java
@@ -1871,6 +1871,7 @@ public class KeyEvent extends InputEvent implements Parcelable {
     public static final boolean isWakeKey(int keyCode) {
         switch (keyCode) {
             case KeyEvent.KEYCODE_BACK:
+            case KeyEvent.KEYCODE_HOME:
             case KeyEvent.KEYCODE_MENU:
             case KeyEvent.KEYCODE_WAKEUP:
             case KeyEvent.KEYCODE_PAIRING:
diff --git a/services/core/java/com/android/server/policy/PhoneWindowManager.java b/services/core/java/com/android/server/policy/PhoneWindowManager.java
index d4c005d213f..c84498354fd 100644
--- a/services/core/java/com/android/server/policy/PhoneWindowManager.java
+++ b/services/core/java/com/android/server/policy/PhoneWindowManager.java
@@ -692,7 +692,8 @@ public class PhoneWindowManager implements WindowManagerPolicy {
     MetricsLogger mLogger;
     private HardkeyActionHandler mKeyHandler;
     boolean mHasNavigationBar = false;
-
+    boolean mHomeWakeScreen;
+    
     private boolean mHandleVolumeKeysInWM;
 
     boolean mVolumeRockerWake;
@@ -1325,6 +1326,9 @@ public class PhoneWindowManager implements WindowManagerPolicy {
             resolver.registerContentObserver(Settings.System.getUriFor(
                     Settings.System.BOTTOM_GESTURE_SWIPE_LIMIT), false, this,
                     UserHandle.USER_ALL);
+            resolver.registerContentObserver(Settings.System.getUriFor(
+                    Settings.System.HOME_WAKE_SCREEN), false, this,
+                    UserHandle.USER_ALL);
             resolver.registerContentObserver(Settings.System.getUriFor(
                     Settings.System.USE_EDGE_SERVICE_FOR_GESTURES), false, this,
                     UserHandle.USER_ALL);
@@ -3296,6 +3300,9 @@ public class PhoneWindowManager implements WindowManagerPolicy {
                     resolver, Settings.System.TORCH_LONG_PRESS_POWER_TIMEOUT, 0,
                     UserHandle.USER_CURRENT);
 
+            mHomeWakeScreen = Settings.System.getIntForUser(resolver,
+                    Settings.System.HOME_WAKE_SCREEN, 0, UserHandle.USER_CURRENT) == 1;
+
             // Configure wake gesture.
             boolean wakeGestureEnabledSetting = Settings.Secure.getIntForUser(resolver,
                     Settings.Secure.WAKE_GESTURE_ENABLED, 0,
@@ -3308,7 +3315,7 @@ public class PhoneWindowManager implements WindowManagerPolicy {
             // navbar
             mHasNavigationBar = DeviceUtils.deviceSupportNavigationBar(mContext);
 
-	    //Three Finger Gesture
+            //Three Finger Gesture
             boolean threeFingerGesture = Settings.System.getIntForUser(resolver,
                     Settings.System.THREE_FINGER_GESTURE, 0, UserHandle.USER_CURRENT) == 1;
             enableSwipeThreeFingerGesture(threeFingerGesture);
@@ -7225,7 +7232,6 @@ public class PhoneWindowManager implements WindowManagerPolicy {
         final int source = event.getSource();
         final boolean navBarKey = source == InputDevice.SOURCE_NAVIGATION_BAR;
         final boolean appSwitchKey = keyCode == KeyEvent.KEYCODE_APP_SWITCH;
-        final boolean homeKey = keyCode == KeyEvent.KEYCODE_HOME;
         final boolean menuKey = keyCode == KeyEvent.KEYCODE_MENU;
         final boolean backKey = keyCode == KeyEvent.KEYCODE_BACK;
         final boolean virtualKey = event.getDeviceId() == KeyCharacterMap.VIRTUAL_KEYBOARD;
@@ -7246,12 +7252,12 @@ public class PhoneWindowManager implements WindowManagerPolicy {
         }
 
         if (mANBIHandler != null && mANBIEnabled && mANBIHandler.isScreenTouched()
-                && !navBarKey && (appSwitchKey || homeKey || menuKey || backKey)) {
+                && !navBarKey && (appSwitchKey || menuKey || backKey)) {
             return 0;
         }
 
         // Disable hw keys in Ambient and when screen off
-        if ((isDozeMode() || !isScreenOn()) && (appSwitchKey || homeKey || menuKey || backKey)) {
+        if ((isDozeMode() || !isScreenOn()) && (appSwitchKey || menuKey || backKey)) {
             return 0;
         }
 
@@ -7393,6 +7399,15 @@ public class PhoneWindowManager implements WindowManagerPolicy {
                 break;
             }
 
+            case KeyEvent.KEYCODE_HOME: {
+                if (down && !interactive && mHomeWakeScreen) {
+                    isWakeKey = true;
+                    Log.i(TAG, "Wakeup from Home");
+                    //mPowerManager.wakeUpWithProximityCheck(event.getDownTime(), "android.policy:HOME");
+                }
+                break;
+            }
+
             case KeyEvent.KEYCODE_VOLUME_DOWN:
             case KeyEvent.KEYCODE_VOLUME_UP:
             case KeyEvent.KEYCODE_VOLUME_MUTE: {
@@ -7748,8 +7763,8 @@ public class PhoneWindowManager implements WindowManagerPolicy {
         }
 
         if (isWakeKey) {
-            wakeUp(event.getEventTime(), mAllowTheaterModeWakeFromKey, "android.policy:KEY",
-                    event.getKeyCode() == KeyEvent.KEYCODE_WAKEUP /* check prox only on wake key*/);
+            wakeUp(event.getEventTime(), mAllowTheaterModeWakeFromKey, "android.policy:KEY", true
+                    /*event.getKeyCode() == KeyEvent.KEYCODE_WAKEUP  check prox only on wake key*/);
         }
 
         return result;
-- 
2.19.1

