From d2fa619e3353d599bb5b051ae2a762e716e446a8 Mon Sep 17 00:00:00 2001
From: Kazakov Stepan <ksrt12group@gmail.com>
Date: Tue, 22 Jan 2019 12:28:08 +0300
Subject: [PATCH 6/9] toggle torch proximity check [1/2]

Signed-off-by: Kazakov Stepan <ksrt12group@gmail.com>
---
 core/java/android/provider/Settings.java                  | 5 +++++
 .../com/android/server/policy/PhoneWindowManager.java     | 8 +++++++-
 2 files changed, 12 insertions(+), 1 deletion(-)

diff --git a/core/java/android/provider/Settings.java b/core/java/android/provider/Settings.java
index 4034fbe5684d..bc31199e8544 100644
--- a/core/java/android/provider/Settings.java
+++ b/core/java/android/provider/Settings.java
@@ -5211,6 +5211,11 @@ public final class Settings {
          */
         public static final String TORCH_LONG_PRESS_POWER_GESTURE = "torch_long_press_power_gesture";
 
+        /**
+         * @hide
+         */
+        public static final String TORCH_LONG_PRESS_POWER_CHECK = "torch_long_press_power_check";
+
         /**
          * @hide
          */
diff --git a/services/core/java/com/android/server/policy/PhoneWindowManager.java b/services/core/java/com/android/server/policy/PhoneWindowManager.java
index 6218d95a12c9..ea428638f4e5 100644
--- a/services/core/java/com/android/server/policy/PhoneWindowManager.java
+++ b/services/core/java/com/android/server/policy/PhoneWindowManager.java
@@ -975,6 +975,7 @@ public class PhoneWindowManager implements WindowManagerPolicy {
     private String mRearFlashCameraId;
     private boolean mTorchLongPressPowerEnabled;
     private boolean mTorchEnabled;
+    private boolean mTorchProximityCheck;
     private int mTorchTimeout;
     private PendingIntent mTorchOffPendingIntent;
 
@@ -1163,7 +1164,7 @@ public class PhoneWindowManager implements WindowManagerPolicy {
     }
 
     private void toggleFlashLightProximityCheck() {
-        if (mProximitySensor != null && mProximityTimeOut != -1) {
+        if (mProximitySensor != null && mProximityTimeOut != -1 && mTorchProximityCheck) {
             if (mHandler.hasMessages(MSG_CLEAR_PROXIMITY)) {
                 // A message is already queued
                 return;
@@ -1334,6 +1335,9 @@ public class PhoneWindowManager implements WindowManagerPolicy {
             resolver.registerContentObserver(Settings.System.getUriFor(
                     Settings.System.BOTTOM_GESTURE_FEEDBACK_DURATION), false, this,
                     UserHandle.USER_ALL);
+            resolver.registerContentObserver(Settings.System.getUriFor(
+                    Settings.System.TORCH_LONG_PRESS_POWER_CHECK), false, this,
+                    UserHandle.USER_ALL);
             resolver.registerContentObserver(Settings.System.getUriFor(
                     Settings.System.USE_EDGE_SERVICE_FOR_GESTURES), false, this,
                     UserHandle.USER_ALL);
@@ -3309,6 +3313,8 @@ public class PhoneWindowManager implements WindowManagerPolicy {
             mTorchLongPressPowerEnabled = Settings.System.getIntForUser(
                     resolver, Settings.System.TORCH_LONG_PRESS_POWER_GESTURE, 0,
                     UserHandle.USER_CURRENT) == 1;
+            mTorchProximityCheck = Settings.System.getIntForUser(resolver,
+                    Settings.System.TORCH_LONG_PRESS_POWER_CHECK, 0, UserHandle.USER_CURRENT) == 1;
             mTorchTimeout = Settings.System.getIntForUser(
                     resolver, Settings.System.TORCH_LONG_PRESS_POWER_TIMEOUT, 0,
                     UserHandle.USER_CURRENT);
-- 
2.20.1

