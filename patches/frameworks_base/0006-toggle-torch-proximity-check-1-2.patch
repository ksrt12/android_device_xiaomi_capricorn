From d4afe6b380057fe075c0ad0796d4dd466f2d9fe6 Mon Sep 17 00:00:00 2001
From: Kazakov Stepan <ksrt12group@gmail.com>
Date: Tue, 22 Jan 2019 12:28:08 +0300
Subject: [PATCH 6/7] toggle torch proximity check [1/2]

Signed-off-by: Kazakov Stepan <ksrt12group@gmail.com>
---
 core/java/android/provider/Settings.java                  | 5 +++++
 .../com/android/server/policy/PhoneWindowManager.java     | 8 +++++++-
 2 files changed, 12 insertions(+), 1 deletion(-)

diff --git a/core/java/android/provider/Settings.java b/core/java/android/provider/Settings.java
index edd5e79fe9b..7b4738d8385 100644
--- a/core/java/android/provider/Settings.java
+++ b/core/java/android/provider/Settings.java
@@ -5201,6 +5201,11 @@ public final class Settings {
          */
         public static final String TORCH_LONG_PRESS_POWER_GESTURE = "torch_long_press_power_gesture";
 
+        /**
+         * @hide
+         */
+        public static final String TORCH_LONG_PRESS_POWER_CHECK = "torch_long_press_power_check";
+
         /**
          * @hide
          */
diff --git a/services/core/java/com/android/server/policy/PhoneWindowManager.java b/services/core/java/com/android/server/policy/PhoneWindowManager.java
index c84498354fd..dfc058adc0d 100644
--- a/services/core/java/com/android/server/policy/PhoneWindowManager.java
+++ b/services/core/java/com/android/server/policy/PhoneWindowManager.java
@@ -970,6 +970,7 @@ public class PhoneWindowManager implements WindowManagerPolicy {
     private String mRearFlashCameraId;
     private boolean mTorchLongPressPowerEnabled;
     private boolean mTorchEnabled;
+    private boolean mTorchProximityCheck;
     private int mTorchTimeout;
     private PendingIntent mTorchOffPendingIntent;
 
@@ -1158,7 +1159,7 @@ public class PhoneWindowManager implements WindowManagerPolicy {
     }
 
     private void toggleFlashLightProximityCheck() {
-        if (mProximitySensor != null && mProximityTimeOut != -1) {
+        if (mProximitySensor != null && mProximityTimeOut != -1 && mTorchProximityCheck) {
             if (mHandler.hasMessages(MSG_CLEAR_PROXIMITY)) {
                 // A message is already queued
                 return;
@@ -1329,6 +1330,9 @@ public class PhoneWindowManager implements WindowManagerPolicy {
             resolver.registerContentObserver(Settings.System.getUriFor(
                     Settings.System.HOME_WAKE_SCREEN), false, this,
                     UserHandle.USER_ALL);
+            resolver.registerContentObserver(Settings.System.getUriFor(
+                    Settings.System.TORCH_LONG_PRESS_POWER_CHECK), false, this,
+                    UserHandle.USER_ALL);
             resolver.registerContentObserver(Settings.System.getUriFor(
                     Settings.System.USE_EDGE_SERVICE_FOR_GESTURES), false, this,
                     UserHandle.USER_ALL);
@@ -3296,6 +3300,8 @@ public class PhoneWindowManager implements WindowManagerPolicy {
             mTorchLongPressPowerEnabled = Settings.System.getIntForUser(
                     resolver, Settings.System.TORCH_LONG_PRESS_POWER_GESTURE, 0,
                     UserHandle.USER_CURRENT) == 1;
+            mTorchProximityCheck = Settings.System.getIntForUser(resolver,
+                    Settings.System.TORCH_LONG_PRESS_POWER_CHECK, 0, UserHandle.USER_CURRENT) == 1;
             mTorchTimeout = Settings.System.getIntForUser(
                     resolver, Settings.System.TORCH_LONG_PRESS_POWER_TIMEOUT, 0,
                     UserHandle.USER_CURRENT);
-- 
2.19.1

